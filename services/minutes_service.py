import os
from anthropic import Anthropic
from dotenv import load_dotenv

# .envファイルの内容を読み込む
load_dotenv()

# Anthropic APIキーの設定（環境変数から取得）
anthropic = Anthropic(api_key=os.environ.get("ANTHROPIC_API_KEY"))

def generate_minutes(text):
    """入力されたテキストからマークダウン形式の議事録を生成する関数"""
    try:
        response = anthropic.messages.create(
            model="claude-3-5-sonnet-20240620",
            max_tokens=4000,
            temperature=0.7,
            messages=[
                {"role": "user", "content": f"""あなたは専門的な議事録作成者です。以下の会議の内容から、非常に詳細で構造化された議事録を作成してください。以下の点に特に注意してください：

1. 各議題とサブトピックに対して、可能な限り詳細な情報を提供してください。議論された内容、提案、懸念事項などを詳しく記述してください。

2. 技術的な詳細、手順、コマンドなどは、具体的な例や説明を含めて正確に記録してください。可能であれば、コードスニペットや具体的なコマンドラインの例を含めてください。

3. プロジェクトの進捗状況、現在の段階、次のステップについて、より具体的な情報を提供してください。

4. 開発環境のセットアップ手順は、各ステップを詳細に説明し、考えられる問題点や注意事項も含めてください。

5. 目標と期限について、より具体的な内容と、それらを達成するための具体的なアクションアイテムを記載してください。

6. 将来の開発計画や機能実装について、より詳細な説明と、それらの機能がプロジェクトにどのように貢献するかの分析を含めてください。

7. コミュニケーションツールの使用方法や、チーム協働の具体的な方法について、詳細な指針を提供してください。

8. 決定事項、行動項目、締め切りが明確な場合は、それらを強調して記載し、担当者や完了条件なども含めてください。

9. 議論された課題や問題点、それらに対する提案された解決策を詳細に記録してください。

10. 次回の会議に向けての準備事項や、会議間で行うべきタスクについて具体的に記載してください。

11. 議事録の最後に、非常に詳細な主要ポイントのサマリーを追加し、重要な決定事項や行動項目を箇条書きで明確にしてください。

さらに、以下の点に注意してマークダウン形式で議事録を作成してください：

- 適切な見出しレベル（#, ##, ###など）を使用して構造を明確にしてください。
- リストには適切なマークダウン記法（- や 1. など）を使用してください。
- 重要な部分は適切に強調（**太字**や*斜体*）してください。
- コードブロックやインラインコードが必要な場合は、適切なマークダウン記法を使用してください。
- 表が必要な場合は、マークダウンの表記法を使用してください。

以下の会議の内容から、上記の指示に従ってマークダウン形式の詳細で包括的な議事録を作成してください：

{text}"""}
            ],
        )
        # Markdown形式のテキストをそのまま返す
        markdown_minutes = response.content[0].text
        return markdown_minutes
    except Exception as e:
        print(f"エラーが発生しました: {str(e)}")
        return "議事録の生成中にエラーが発生しました。"